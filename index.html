<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>G5 & FX Data Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f5f6f7; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .menu-bar { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
        button { padding: 10px 18px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-tab { background: #e0e0e0; color: #333; }
        .btn-tab.active { background: #007bff; color: white; }
        .tool-section { display: none; }
        .tool-section.active { display: block; }
        #drop-zone, .upload-box { border: 2px dashed #007bff; padding: 30px; text-align: center; margin-bottom: 15px; border-radius: 8px; background: #f0f7ff; cursor: pointer; position: relative; }
        #drop-zone:hover, .upload-box:hover { background: #e6f2ff; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
        th { background: #007bff; color: white; position: sticky; top: 0; }
        .action-area { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-green { background: #28a745; color: white; }
        .btn-orange { background: #fd7e14; color: white; }
        .btn-red { background: #dc3545; color: white; }
        .file-info { color: #28a745; margin-top: 10px; font-weight: normal; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <div class="menu-bar">
        <button id="tab1-btn" class="btn-tab active" onclick="showTab(1)">Tạo Checklist G5 mới từ nhiều SVC</button>
        <button id="tab2-btn" class="btn-tab" onclick="showTab(2)">JOB chuyển đổi - Ghép bess vào 動画設定G5</button>
        <button class="btn-tab" disabled>Upcoming</button>
        <button class="btn-tab" disabled>Upcoming</button>
    </div>

    <div id="section1" class="tool-section active">
        <div id="drop-zone" onclick="document.getElementById('file-svc').click()">
            Kéo thả hoặc Click chọn các file <b>SVC</b>
            <input type="file" id="file-svc" multiple accept=".xlsx, .xlsm" style="display:none">
            <div id="svc-list" class="file-info"></div>
        </div>
        <div class="action-area">
            <button class="btn-green" onclick="processSVC()">Bắt đầu ghép dữ liệu</button>
            <button class="btn-orange" onclick="copyTable('table-svc-body')">Copy kết quả (Không tiêu đề)</button>
            <button class="btn-red" onclick="clearTool(1)">Clear (Làm mới)</button>
        </div>
        <div style="overflow: auto; max-height: 500px;">
            <table>
                <thead>
                    <tr>
                        <th>A(T)</th><th>B(N)</th><th>C(O)</th><th>D(Q)</th><th>E(S)</th><th>F(M)</th>
                        <th>G(V)</th><th>H(AY)</th><th>I(AZ)</th><th>J(BA)</th><th>K(BB)</th><th>L(BC)</th>
                    </tr>
                </thead>
                <tbody id="table-svc-body"></tbody>
            </table>
        </div>
    </div>

    <div id="section2" class="tool-section">
        <div class="upload-box" onclick="document.getElementById('file-g5').click()">
            <b>Upload file G5 convert tại đây</b>
            <input type="file" id="file-g5" accept=".xlsx, .xlsm" style="display:none">
            <div id="g5-name" class="file-info"></div>
        </div>
        <div class="upload-box" onclick="document.getElementById('file-fx').click()">
            <b>Upload file checklist FX tại đây</b>
            <input type="file" id="file-fx" accept=".xlsx, .xlsm" style="display:none">
            <div id="fx-name" class="file-info"></div>
        </div>
        <div class="action-area">
            <button class="btn-green" onclick="processG5FX()">Thực hiện chuyển đổi</button>
            <button class="btn-orange" onclick="copyTable('table-g5fx-body', true)">Copy kết quả (Bỏ 2 cột đầu)</button>
            <button class="btn-red" onclick="clearTool(2)">Clear (Làm mới)</button>
        </div>
        <div style="overflow: auto; max-height: 500px;">
            <table id="table-g5fx">
                <thead>
                    <tr>
                        <th style="background:#6c757d">G (G5)</th><th style="background:#6c757d">H (G5)</th>
                        <th>I (FX)</th><th>J (FX)</th><th>K (FX)</th><th>L (FX)</th><th>M (FX)</th>
                        <th>R (FX)</th><th>S (FX)</th><th>T (FX)</th>
                    </tr>
                </thead>
                <tbody id="table-g5fx-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- CHUNG ---
    function showTab(n) {
        document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
        document.getElementById('section' + n).classList.add('active');
        document.getElementById('tab' + n + '-btn').classList.add('active');
    }

    function clearTool(n) {
        if (n === 1) {
            svcFiles = [];
            document.getElementById('file-svc').value = "";
            document.getElementById('svc-list').innerText = "";
            document.getElementById('table-svc-body').innerHTML = "";
        } else {
            fileG5 = null; fileFX = null;
            document.getElementById('file-g5').value = "";
            document.getElementById('file-fx').value = "";
            document.getElementById('g5-name').innerText = "";
            document.getElementById('fx-name').innerText = "";
            document.getElementById('table-g5fx-body').innerHTML = "";
        }
        alert("Đã làm mới dữ liệu Tab " + n);
    }

    function readExcel(file, sheetIndex = 0) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, { type: 'binary' });
                const sheetName = wb.SheetNames[sheetIndex];
                const sheet = wb.Sheets[sheetName];
                resolve(XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" }));
            };
            reader.readAsBinaryString(file);
        });
    }

    function normalize(val) {
        if (val === undefined || val === null || val === "") return "";
        return String(val).replace(/^0+/, '').trim();
    }

    function copyTable(bodyId, skipFirstTwo = false) {
        const body = document.getElementById(bodyId);
        if (body.rows.length === 0) return alert("Không có dữ liệu để copy!");
        
        const sel = window.getSelection();
        sel.removeAllRanges();
        const range = document.createRange();

        if (skipFirstTwo) {
            let tempTable = document.createElement("table");
            Array.from(body.rows).forEach(row => {
                let newRow = tempTable.insertRow();
                for (let i = 2; i < row.cells.length; i++) {
                    let newCell = newRow.insertCell();
                    newCell.innerText = row.cells[i].innerText;
                }
            });
            document.body.appendChild(tempTable);
            range.selectNode(tempTable);
            sel.addRange(range);
            document.execCommand('copy');
            document.body.removeChild(tempTable);
        } else {
            range.selectNodeContents(body);
            sel.addRange(range);
            document.execCommand('copy');
        }
        alert("Đã copy dữ liệu vào Clipboard!");
        sel.removeAllRanges();
    }

    // --- TAB 1: SVC ---
    let svcFiles = [];
    document.getElementById('file-svc').onchange = (e) => {
        svcFiles = Array.from(e.target.files).filter(f => f.name.toLowerCase().startsWith('svc'))
                        .sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));
        document.getElementById('svc-list').innerText = "Đã chọn: " + svcFiles.map(f => f.name).join(", ");
    };

    async function processSVC() {
        if(svcFiles.length === 0) return alert("Vui lòng chọn file SVC!");
        const body = document.getElementById('table-svc-body');
        const colMap = [19, 13, 14, 16, 18, 12, 21, 50, 51, 52, 53, 54];
        body.innerHTML = "";
        for (let f of svcFiles) {
            let rows = (await readExcel(f)).slice(5);
            let lastIdx = -1;
            for(let i=rows.length-1; i>=0; i--) {
                if(rows[i].some(c => String(c).trim() !== "")) { lastIdx = i; break; }
            }
            if(lastIdx !== -1) {
                rows.slice(0, lastIdx + 1).forEach(row => {
                    let tr = body.insertRow();
                    colMap.forEach(idx => tr.insertCell().innerText = row[idx] || "");
                });
            }
        }
        alert("Ghép SVC hoàn tất!");
    }

    // --- TAB 2: G5 & FX ---
    let fileG5, fileFX;
    document.getElementById('file-g5').onchange = (e) => { fileG5 = e.target.files[0]; document.getElementById('g5-name').innerText = "File đã chọn: " + fileG5.name; };
    document.getElementById('file-fx').onchange = (e) => { fileFX = e.target.files[0]; document.getElementById('fx-name').innerText = "File đã chọn: " + fileFX.name; };

    async function processG5FX() {
        if(!fileG5 || !fileFX) return alert("Vui lòng chọn đủ 2 file!");
        const dataG5 = (await readExcel(fileG5, 0)).slice(5);
        const dataFX = (await readExcel(fileFX, 1)).slice(4);
        const body = document.getElementById('table-g5fx-body');
        body.innerHTML = "";

        dataG5.forEach(gRow => {
            let tr = body.insertRow();
            tr.insertCell().innerText = gRow[6] || ""; 
            tr.insertCell().innerText = gRow[7] || "";

            let g6Val = String(gRow[6] || "");
            let [aa, bb] = g6Val.split('.');
            let cc = String(gRow[7] || "").substring(0, 2);

            let match = dataFX.find(fRow => {
                let xx = normalize(fRow[5]);
                let yy = normalize(fRow[6]);
                let zz = normalize(fRow[7]);
                return normalize(aa) === xx && normalize(bb) === yy && normalize(cc) === zz;
            });

            const fxCols = [8, 9, 10, 11, 12, 17, 18, 19];
            fxCols.forEach(idx => {
                tr.insertCell().innerText = match ? (match[idx] || "") : "";
            });
        });
        alert("Chuyển đổi hoàn tất!");
    }
</script>
</body>
</html>
